import { createConnection } from 'typeorm'
import { EnvConfigService } from 'src/modules/config/services/Env'
import { parse } from 'pg-connection-string'

export const databaseProviders = [
  {
    provide: 'DATABASE_CONNECTION',
    useFactory: (configService: EnvConfigService) => {
      const pgUrl = parse(configService.getString('DATABASE_URL'))

      return createConnection({
        type: 'mysql',
        host: pgUrl.host,
        port: Number(pgUrl.port),
        username: pgUrl.user,
        password: pgUrl.password,
        database: pgUrl.database,
        entities: [
          `${__dirname}/../**/*.entity.ts`,
        ],
        synchronize: true,
      })
    },
  },
]
